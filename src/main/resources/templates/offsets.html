<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Offsets</title>

    <link rel="stylesheet" href="/css/offsetStyle.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>


    <script src="/javascript/firebase-auth.js"></script>
</head>
<body onload="checkAuthCarbon()">

<div class="header"></div>
<div class="banner">
    <a class="toursp" href="/tours">Tours</a>
    <p class="offestp">Offsets</p>
</div>
<div class="icon-container" onclick="toggleCollapsible()">
    <i class="fa-solid fa-user"></i>
</div>

<div class="content">
    <p id="userInfo" style="display: none;"></p>
    <div id="logoutSection" style="display: none;">
        <button class="logoutButton" onclick="logout()">Logout</button>
    </div>
</div>

<div>
    <h3>Total Carbon Emissions: <span id="totalCarbon">0</span></h3>
</div>

<div>
    <h3>Total Seats: <span id="totalSeats">0</span></h3>
</div>

<div class="offset-wrapper">
    <div class = "tours">
        <div th:each="tour : ${overTours}">
        <span th:switch="${tour.getOffset}">
            <span th:case="false">
                <input type="checkbox" class="offsetCheck" name="offsetCheck"
                       th:value="${tour.carbonEmissions} + ':' + ${tour.noOfSeats}"
                       onclick="updateTotalCarbon()">
                <label th:text="${tour.tourName} + ': ' + ${tour.carbonEmissions} + ' kg CO₂' + ', ' + ${tour.noOfSeats} + ' seats'"></label>
            </span>
        </span>
        </div>
    </div>

    <div class="offset_companies-container">
        <div th:each="company : ${offsetCompaniesMap}">
            <h2 th:text="${company.getKey()}" class="company-name hidden"
                th:attr="data-company=${company.getKey()}, data-offset=${company.getValue().split(' ')[1]}">
            </h2>
            <a th:href="${company.getValue().split(' ')[0]}" class="company-link" target="_blank" th:text="${company.getKey()}"></a>
            <p>Offset Carbon: <span class="company-offset-value">0</span></p>
        </div>
    </div>


</div>

<script>
    function toggleCollapsible() {
        var content = document.querySelector(".content");
        var userInfo = document.getElementById("userInfo");
        var logoutSection = document.getElementById("logoutSection");

        if (content.style.display === "none" || content.style.display === "") {
            content.style.display = "block";
            userInfo.style.display = "block";
            logoutSection.style.display = "block";
        } else {
            content.style.display = "none";
            userInfo.style.display = "none";
            logoutSection.style.display = "none";
        }
    }

    function updateTotalCarbon() {
        let totalCarbon = 0;
        let totalSeats = 0;
        let companyTotals = {};

        document.querySelectorAll(".company-name").forEach(company => {
            let companyName = company.textContent.trim();
            let offsetFactor = parseFloat(company.getAttribute("data-offset"));
            if (!isNaN(offsetFactor)) {
                companyTotals[companyName] = 0;
            }
        });

        document.querySelectorAll('.offsetCheck:checked').forEach(checkbox => {
            const parts = checkbox.value.split(":");
            let carbonEmissions = parseFloat(parts[0]);
            let seats = parseInt(parts[1]);

            totalCarbon += carbonEmissions;
            totalSeats += seats;

            for (let company in companyTotals) {
                let offsetFactor = parseFloat(document.querySelector(`[data-company='${company}']`).getAttribute("data-offset"));
                companyTotals[company] += carbonEmissions * offsetFactor;
            }
        });

        document.getElementById("totalCarbon").textContent = totalCarbon.toFixed(2) + ' kg CO₂ / ' + (totalCarbon/1000).toFixed(2) + ' Tonnes CO₂';
        document.getElementById("totalSeats").textContent = totalSeats;

        for (let company in companyTotals) {
            let companyElement = document.querySelector(`[data-company='${company}']`)?.parentElement.querySelector(".company-offset-value");
            if (companyElement) {
                companyElement.textContent = companyTotals[company].toFixed(2) + ' Euro ' + (companyTotals[company].toFixed(3)/totalSeats).toFixed(2) + ' per ticket';
            }
        }
    }


</script>

</body>
</html>